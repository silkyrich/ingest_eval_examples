# Problem statment
Every Splunk component generates numerous log files including `metrics.log`, `splunkd.log`, `health.log` and more. These log files all share the same sourcetype `splunkd` and this is written to the index `_internal`. This index is normally in the top largest indexes on any Splunk platform and the contents are vital to monitoring and debugging splunk. In later releases `thread_name` and `thread_id` has been added to logging from `splunkd.log`. Because of its size searching the `_internal` index is expensive and slow.

## Existing solution
By default enrichment of the `splunkd` sourcetype is done at search time using schema on the fly. This highly efficent if you are not searching that index as you save parsing costs at point of ingestion. However at point of searching this is expensive and time consuming.

## Proposed Solution
To aid the performance of searching the `splunkd` sourcetype we will use a `REGEX` transform to extract the fields `component`, `log_line`, `thread_name` and `thread_id` from the log files and write them into indexed fields during ingestion. This will increase the parsing costs at ingestion time, but will reduce searching costs when referencing the indexed fields.

### Example data
The following log lines are from a splunks instance and show both formats for splunkd log.

    # 09-21-2020 09:51:06.241 +0000 INFO  TailReader [10099 batchreader1] - Starting batchreader1 thread
    # 09-21-2020 09:50:57.229 +0000 INFO  CMSlave [9659 MainThread] - starting heartbeat thread
    # 09-21-2020 09:50:57.229 +0000 INFO  CMSlave - starting heartbeat thread

### Steps

1. We start with a `REGEX` extraction to extract the fields `component`, `log_line`, `thread_name` and `thread_id`
1. The fields `thread_name` and `thread_id` are optional which will create empty indexed fields
1. We use INGEST_EVAL to remove the indexed fields `thread_name` and `thread_id` when they were empty
1. While indexing the log line extracting the tokens, we use a custom segementation option to drop the time and date, and we stop the generation of major breakers (use the dynamic indexed fields pattern for this sourcetype)

### props.conf

    # this transform applies a REGEX transform to extract the log_level, the component and thread name and if is it there
    [enrich_splunkd_component_level_thread]
    TIME_PREFIX = ^
    TIME_FORMAT = %m-%d-%Y %H:%M:%S.%l %z
    SHOULD_LINEMERGE=false
    LINE_BREAKER=([\n\r]+)
    TRANSFORMS-enrich-splunkd-log_level = enrich_splunkd_component_level_thread-extract_log_level_etc, enrich_splunkd_component_level_thread-drop_null_thread_info

### transforms.conf

    [enrich_splunkd_component_level_thread-extract_log_level_etc]
    SOURCE_KEY = _raw
    WRITE_META = true
REGEX = ^\d\d\-\d\d-\d{4}\s\d\d:\d\d\:\d\d\.\d{0,6}\s[+\-]\d{4}\s(INFO|DEBUG|ERROR|WARN|DEBUG)\s+(\S+)\s(?:\[(\d+)\s(\S+)\])?
    FORMAT = log_level::$1 component::$2 thread_id::$3 thread_name::$4 

    [enrich_splunkd_component_level_thread-drop_null_thread_info]
    INGEST_EVAL = thread_id:=if(thread_id="",null(),thread_id), thread_name:=if(thread_name="",null(),thread_name)
    
### Segmentors.conf

    # This stanza has been built to disable major breakers and to not index the date time portion
    # of the event. Together they dramatically reduce the number of tokens generated by this source, which reduces
    # the bloat in tsidx
    [enrich_splunkd_component_level_thread]
    FILTER = ^\d\d-\d\d-\d{4}\s\d\d:\d\d:\d\d\.\d\d\d [-+]\d{4} (.*)$
    INTERMEDIATE_MAJORS = false
    MAJOR = [ ] < > ( ) { } | ! ; , ' " \n \r \s \t & ? + %21 %26 %2526 %3B %7C %20 %2B %3D -- %2520 %5D %5B %3A %0A %2C %28 %29 / : = @ . - $ # % \\ _
    MINOR = 